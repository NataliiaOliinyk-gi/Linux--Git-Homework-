# Post Mortem: Анализ инцидента с web-сервером

## 1. Причины инцидента

### Технические ошибки:

- Пустой файл конфигурации.
- Некорректный IP-адрес в настройке приложения.
- Ошибка в настройке cron – архивация логов происходила каждую минуту.

### Ресурсные проблемы:

- Переполненный диск (100% занятого места).
- Логи не очищались и занимали значительное пространство.

### Операционные факторы:

- Отсутствие мониторинга дискового пространства и логов.
- Отсутствие механизмов автоматической ротации логов.

## 2. Предпринятые шаги для восстановления сервиса и устранения проблемы

1. Подключились к серверу через SSH, предварительно скорректировав права ключа (`chmod u=rw,go= ich.pem`).
2. Проверили статус сервиса (`sudo service httpd status`) – он был выключен (`inactive (dead)`).
3. Попытка запуска сервиса (`sudo service httpd start`) не удалась.
4. Проверили свободное место (`df -h`) – диск был переполнен (100% занятого места).
5. Выяснили, что большая часть места занята логами и архивами (`find / -type f -size +100M`).
6. Очистили логи командой:

```bash
> /var/log/httpd/access_log
```

7. После очистки места **сервис запустился**, но возникла новая проблема – **ошибка в файле конфигурации приложения**.
8. Выяснили, что файл настроек приложения должен находиться в `/var/www/html/mediawiki/`, но он был пустой.
9. Настройки приложения есть в файле `/home/ec2-user/LocalSettings(5).php`. Попытались скопировать этот файл, но операция не удалась.
10. Проверили журнал ошибок веб-сервера командой:

```bash
        sudo cat /var/log/httpd/error_log
```

Обнаружили, что снова **закончилось место на диске**.

11. Удалили старый архив логов, чтобы освободить место:

```bash
        sudo rm /var/log/httpd/log_20240402.tar.gz
```

12. После освобождения места успешно скопировали конфигурационный файл командой:

```bash
        cp /home/ec2-user/LocalSettings\ \(5\).php /var/www/html/mediawiki/LocalSettings.php
```

13. После этого сайт по-прежнему не работал.
14. Проверили файл конфигурации и **обнаружили ошибку в IP-адресе сервера**.
15. Внесли исправления в конфигурацию, указав правильный IP `3.77.35.146`.
16. После исправления IP-адреса **веб-приложение полностью восстановило работоспособность**. Провели тестирование работы сайта – все функции работают корректно.
17. Проверили cron (`crontab -l`) – выяснили, что архивирование логов выполнялось слишком часто (архивация логов происходила каждую минуту).
18. Удалили некоррентное задание в cron (`crontab -e`)
19. Переписали скрипт логирования:

```bash
        #!/bin/bash

LOG_DIR="/var/log/httpd"
TARGET_FILE="access_log"
DATE=$(date +%Y%m%d)
BACKUP_DIR=$LOG_DIR
BACKUP_FILE="$BACKUP_DIR/backup-$DATE.tar.gz"

# Создаем директорию для бекапа
mkdir -p "$BACKUP_DIR"

# Архивируем лог файлы
tar -czf "$BACKUP_FILE" "$LOG_DIR/$TARGET_FILE"

# Очищаем файл который архивируем
> "$LOG_DIR/$TARGET_FILE"

# Удаляем старые архивы
find "$BACKUP_DIR" -maxdepth 1 -type f -name "*.tar.gz" -mtime +3 -delete
```

20. Настроили cron так, чтобы он запускался 1 раз в сутки:

```bash
        0 10 * * * /home/ec2-user/backup_logs.sh
```

## 3. Полученные результаты:

- [x] Сайт работает.
- [x] Файл конфигурации с правильными настройками находится в правильном месте.
- [x] Освобождено место на диске.
- [x] Логи теперь архивируются и удаляются по корректному расписанию.
- [x] Настроен правильный интервал выполнения cron-задания.

## Pекомендации и предложения по улучшению процессов

- **Автоматизировать мониторинг диска**: настроить уведомления при занятии >70% диска.
- **Контролировать целостность конфигурационных файлов** (например, с помощью `checksum`).
- **Использовать** `logrotate` вместо ручного скрипта для ротации логов.
- **Проверять новые cron-задания** перед их применением.
- **Ограничить права доступа к серверу** и критическим файлам.
